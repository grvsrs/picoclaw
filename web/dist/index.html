<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sovereign Agent System</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#1754cf",
        "bg-dark": "#0a0a0a",
        "bg-card": "#111318",
        "border-d": "#1e2028",
        "accent-cyan": "#00f5ff",
        "accent-green": "#39ff14",
        warn: "#f59e0b",
        error: "#ef4444",
        success: "#22c55e",
      },
      fontFamily: {
        display: ["Space Grotesk", "sans-serif"],
        mono: ["ui-monospace","SFMono-Regular","Menlo","monospace"],
      },
    },
  },
};
</script>
<style>
  body { font-family: "Space Grotesk", sans-serif; }
  .terminal-grid {
    background-image: radial-gradient(rgba(23,84,207,0.08) 1px, transparent 0);
    background-size: 24px 24px;
  }
  .glow-green { text-shadow: 0 0 8px rgba(57,255,20,0.5); }
  .glow-blue  { box-shadow: 0 0 15px rgba(23,84,207,0.35); }
  .ms { font-family: "Material Symbols Outlined"; font-weight: normal;
         font-style: normal; font-size: 20px; line-height: 1; letter-spacing: normal;
         text-transform: none; white-space: nowrap; word-wrap: normal;
         direction: ltr; -webkit-font-feature-settings: 'liga';
         font-feature-settings: 'liga'; -webkit-font-smoothing: antialiased; }
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: #0a0a0a; }
  ::-webkit-scrollbar-thumb { background: #1754cf55; border-radius: 4px; }
  .nav-item.active { background: #1754cf; color: white; }
  .nav-item { color: #64748b; transition: all .15s; }
  .nav-item:hover:not(.active) { background: rgba(255,255,255,.05); color: #94a3b8; }
  .card { background: #111318; border: 1px solid #1e2028; border-radius: 12px; }
  .badge-enabled  { background: rgba(57,255,20,.1); color: #39ff14; border: 1px solid rgba(57,255,20,.3); }
  .badge-disabled { background: rgba(255,255,255,.05); color: #64748b; border: 1px solid rgba(255,255,255,.1); }
  .tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:700; letter-spacing:.05em; text-transform:uppercase; }
  input, textarea { background: rgba(255,255,255,.05) !important; border-color: #1e2028 !important; color: #f1f5f9 !important; }
  input:focus, textarea:focus { border-color: #1754cf !important; outline: none; box-shadow: 0 0 0 2px rgba(23,84,207,.2) !important; }
  .chat-bubble-user { background: #1754cf22; border: 1px solid #1754cf44; border-radius: 12px 12px 4px 12px; }
  .chat-bubble-agent { background: #111318; border: 1px solid #1e2028; border-radius: 12px 12px 12px 4px; }
  .kanban-col { background: #0d0f14; border: 1px solid #1e2028; border-radius: 10px; min-height: 300px; }
  .kanban-card { background: #111318; border: 1px solid #1e2028; border-radius: 8px; cursor: pointer; transition: border-color .15s; }
  .kanban-card:hover { border-color: #1754cf55; }
  #auth-overlay { backdrop-filter: blur(8px); background: rgba(10,10,10,.85); }
  .sect { display: none; }
  .sect.active { display: block; }
  .spinner { width: 16px; height: 16px; border: 2px solid #1754cf44; border-top-color: #1754cf; border-radius: 50%; animation: spin .6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-bg-dark text-slate-100 min-h-screen overflow-x-hidden">

<!-- ── Auth Overlay ─────────────────────────────────────────────── -->
<div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <div class="card p-8 w-full max-w-sm">
    <div class="flex items-center gap-3 mb-6">
      <span class="ms text-primary text-4xl">deployed_code</span>
      <h2 class="text-xl font-black uppercase tracking-tight">Sovereign <span class="text-primary">Agent</span></h2>
    </div>
    <p class="text-slate-500 text-sm mb-4">Enter your API key to access the dashboard.</p>
    <input id="auth-key-input" type="password" placeholder="API key..." class="w-full px-3 py-2 rounded-lg text-sm mb-3 font-mono"/>
    <button onclick="saveApiKey()" class="w-full py-2 bg-primary rounded-lg text-sm font-bold hover:bg-primary/80 transition-colors glow-blue">
      Connect
    </button>
    <p id="auth-error" class="text-error text-xs mt-3 hidden">Invalid key — access denied</p>
  </div>
</div>

<!-- ── Header ───────────────────────────────────────────────────── -->
<header class="flex items-center justify-between border-b border-border-d bg-bg-dark/90 backdrop-blur-md px-5 py-3 sticky top-0 z-40">
  <div class="flex items-center gap-5">
    <div class="flex items-center gap-2.5">
      <span class="ms text-primary text-3xl">deployed_code</span>
      <h2 class="text-lg font-black tracking-tight uppercase">Sovereign <span class="text-primary">Agent</span> System</h2>
    </div>
    <div class="h-5 w-px bg-white/10 hidden md:block"></div>
    <div class="hidden md:flex items-center gap-3">
      <span id="hdr-health" class="tag badge-disabled">● unknown</span>
      <span id="hdr-model" class="tag" style="background:rgba(23,84,207,.12);color:#7ca2f7;border:1px solid rgba(23,84,207,.3);">model —</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <button onclick="refreshCurrentSection()" title="Refresh" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
      <span class="ms text-slate-400 text-xl">refresh</span>
    </button>
    <button onclick="showAuthOverlay()" title="API Settings" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
      <span class="ms text-slate-400 text-xl" id="hdr-key-icon">key</span>
    </button>
    <div class="size-8 rounded-lg bg-gradient-to-br from-primary to-accent-cyan flex items-center justify-center font-black text-xs select-none">SA</div>
  </div>
</header>

<!-- ── Body: Sidebar + Content ──────────────────────────────────── -->
<div class="flex" style="min-height: calc(100vh - 53px);">

  <!-- Sidebar -->
  <aside class="w-56 border-r border-border-d bg-bg-dark flex-shrink-0 flex flex-col p-3 gap-1 sticky top-[53px] h-[calc(100vh-53px)] overflow-y-auto">
    <nav class="flex flex-col gap-0.5">
      <a class="nav-item active flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('overview')" href="#">
        <span class="ms text-[20px]">dashboard</span><span>Overview</span>
      </a>
      <a class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('channels')" href="#">
        <span class="ms text-[20px]">hub</span><span>Channels</span>
      </a>
      <a class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('agents')" href="#">
        <span class="ms text-[20px]">smart_toy</span><span>Agents &amp; Tools</span>
      </a>
      <a class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('kanban')" href="#">
        <span class="ms text-[20px]">view_kanban</span><span>Kanban</span>
      </a>
      <a class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('logs')" href="#">
        <span class="ms text-[20px]">terminal</span><span>Live Logs</span>
      </a>
      <a class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-sm" onclick="showSection('chat')" href="#">
        <span class="ms text-[20px]">chat</span><span>Chat</span>
      </a>
    </nav>
    <div class="mt-auto">
      <div class="px-3 py-2 rounded-lg bg-white/3 border border-border-d">
        <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-2">System</p>
        <div class="flex justify-between text-xs mb-1">
          <span class="text-slate-500">Uptime</span>
          <span id="sb-uptime" class="text-slate-400 font-mono">—</span>
        </div>
        <div class="flex justify-between text-xs mb-1">
          <span class="text-slate-500">Memory</span>
          <span id="sb-mem" class="text-slate-400 font-mono">—</span>
        </div>
        <div class="flex justify-between text-xs">
          <span class="text-slate-500">Goroutines</span>
          <span id="sb-goroutines" class="text-slate-400 font-mono">—</span>
        </div>
      </div>
      <p class="text-[10px] text-slate-700 text-center mt-3">picoclaw · <span id="sb-version">dev</span></p>
    </div>
  </aside>

  <!-- ── Main Content ─────────────────────────────────────────── -->
  <main class="flex-1 overflow-y-auto terminal-grid">

    <!-- ════════════════ OVERVIEW ════════════════ -->
    <section id="sect-overview" class="sect active p-6">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">System <span class="text-primary italic">Overview</span></h1>
          <p class="text-slate-600 font-mono text-xs">PATH: /api/system/status</p>
        </div>
        <button onclick="loadOverview()" class="px-4 py-2 bg-white/5 border border-border-d rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-white/10 transition-all">
          <span class="ms text-sm">refresh</span> REFRESH
        </button>
      </div>

      <!-- Stat Grid -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-primary text-2xl mb-1">memory</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Memory</p>
          <p id="ov-mem" class="text-xl font-black font-mono text-accent-cyan">—</p>
        </div>
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-accent-green text-2xl mb-1">timer</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Uptime</p>
          <p id="ov-uptime" class="text-xl font-black font-mono text-accent-green">—</p>
        </div>
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-warn text-2xl mb-1">settings_ethernet</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Goroutines</p>
          <p id="ov-goroutines" class="text-xl font-black font-mono text-warn">—</p>
        </div>
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-primary text-2xl mb-1">forum</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Sessions</p>
          <p id="ov-sessions" class="text-xl font-black font-mono text-primary">—</p>
        </div>
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-accent-cyan text-2xl mb-1">build</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Tools</p>
          <p id="ov-tools" class="text-xl font-black font-mono text-accent-cyan">—</p>
        </div>
        <div class="card p-4 flex flex-col gap-1">
          <span class="ms text-slate-400 text-2xl mb-1">schedule</span>
          <p class="text-[10px] text-slate-500 uppercase font-bold">Cron Jobs</p>
          <p id="ov-cron" class="text-xl font-black font-mono text-slate-300">—</p>
        </div>
      </div>

      <!-- Agent + Channel status row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="card p-5">
          <div class="flex items-center gap-2 mb-4">
            <span class="ms text-primary">smart_toy</span>
            <h3 class="font-bold text-sm uppercase tracking-widest">Agent Status</h3>
          </div>
          <div id="ov-agent-body" class="space-y-2 text-sm text-slate-400">Loading...</div>
        </div>
        <div class="card p-5">
          <div class="flex items-center gap-2 mb-4">
            <span class="ms text-accent-cyan">hub</span>
            <h3 class="font-bold text-sm uppercase tracking-widest">Active Channels</h3>
          </div>
          <div id="ov-channels-body" class="space-y-2">Loading...</div>
        </div>
      </div>

      <!-- Sessions list -->
      <div class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="ms text-slate-400">forum</span>
            <h3 class="font-bold text-sm uppercase tracking-widest">Sessions</h3>
          </div>
          <span id="ov-session-count" class="text-xs text-slate-600 font-mono">—</span>
        </div>
        <div id="ov-sessions-list" class="space-y-2 text-sm">Loading...</div>
      </div>
    </section>

    <!-- ════════════════ CHANNELS ════════════════ -->
    <section id="sect-channels" class="sect p-6">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">Messaging <span class="text-primary italic">Channels</span></h1>
          <p class="text-slate-600 font-mono text-xs">PATH: /api/channels</p>
        </div>
        <button onclick="loadChannels()" class="px-4 py-2 bg-white/5 border border-border-d rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-white/10 transition-all">
          <span class="ms text-sm">refresh</span> REFRESH
        </button>
      </div>

      <div class="mb-4 p-4 rounded-xl border border-primary/20 bg-primary/5 text-sm text-slate-300">
        <span class="ms text-primary text-base align-middle mr-2">info</span>
        To enable a channel, add its credentials to <code class="font-mono text-primary text-xs">config.json</code> and set <code class="font-mono text-primary text-xs">"enabled": true</code>. Restart picoclaw.
      </div>

      <div id="channels-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <div class="text-slate-600 text-sm">Loading...</div>
      </div>
    </section>

    <!-- ════════════════ AGENTS & TOOLS ════════════════ -->
    <section id="sect-agents" class="sect p-6">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">Agents <span class="text-primary italic">&amp; Tools</span></h1>
          <p class="text-slate-600 font-mono text-xs">PATH: /api/agent/status + /api/tools</p>
        </div>
        <button onclick="loadAgents()" class="px-4 py-2 bg-white/5 border border-border-d rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-white/10 transition-all">
          <span class="ms text-sm">refresh</span> REFRESH
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="card p-5 lg:col-span-1">
          <div class="flex items-center gap-2 mb-4">
            <span class="ms text-primary">smart_toy</span>
            <h3 class="font-bold text-sm uppercase tracking-widest">Agent Config</h3>
          </div>
          <div id="agent-config-body" class="space-y-2 text-sm text-slate-400">Loading...</div>
        </div>
        <div class="card p-5 lg:col-span-2">
          <div class="flex items-center gap-2 mb-4">
            <span class="ms text-accent-cyan">build</span>
            <h3 class="font-bold text-sm uppercase tracking-widest">Registered Tools (<span id="tools-count">—</span>)</h3>
          </div>
          <div id="tools-list" class="space-y-2">Loading...</div>
        </div>
      </div>

      <!-- Cron Jobs -->
      <div class="card p-5">
        <div class="flex items-center gap-2 mb-4">
          <span class="ms text-warn">schedule</span>
          <h3 class="font-bold text-sm uppercase tracking-widest">Cron Jobs</h3>
        </div>
        <div id="cron-list" class="space-y-2 text-sm">Loading...</div>
      </div>
    </section>

    <!-- ════════════════ KANBAN ════════════════ -->
    <section id="sect-kanban" class="sect p-6">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">Task <span class="text-primary italic">Board</span></h1>
          <p class="text-slate-600 font-mono text-xs">PATH: /api/tasks</p>
        </div>
        <div class="flex gap-2">
          <button onclick="showAddTask()" class="px-4 py-2 bg-primary text-white rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-primary/80 transition-all glow-blue">
            <span class="ms text-sm">add</span> NEW TASK
          </button>
          <button onclick="loadKanban()" class="px-4 py-2 bg-white/5 border border-border-d rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-white/10">
            <span class="ms text-sm">refresh</span>
          </button>
        </div>
      </div>

      <!-- Add task form (hidden) -->
      <div id="add-task-form" class="hidden card p-4 mb-4">
        <h4 class="font-bold text-sm mb-3">New Task</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="task-title" placeholder="Title..." class="px-3 py-2 rounded-lg text-sm"/>
          <input id="task-project" placeholder="Project (optional)..." class="px-3 py-2 rounded-lg text-sm"/>
          <div class="flex gap-2">
            <button onclick="createTask()" class="flex-1 py-2 bg-primary rounded-lg text-xs font-bold hover:bg-primary/80 transition-colors">Create</button>
            <button onclick="hideAddTask()" class="px-3 py-2 bg-white/5 rounded-lg text-xs font-bold hover:bg-white/10 transition-colors">Cancel</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="kanban-col p-3">
          <div class="flex items-center gap-2 mb-3">
            <span class="size-2 rounded-full bg-slate-500"></span>
            <span class="text-xs font-bold uppercase text-slate-500">Inbox</span>
            <span id="kb-count-inbox" class="ml-auto text-xs font-mono text-slate-600">0</span>
          </div>
          <div id="kb-inbox" class="space-y-2"></div>
        </div>
        <div class="kanban-col p-3">
          <div class="flex items-center gap-2 mb-3">
            <span class="size-2 rounded-full bg-primary"></span>
            <span class="text-xs font-bold uppercase text-primary">Planned</span>
            <span id="kb-count-planned" class="ml-auto text-xs font-mono text-slate-600">0</span>
          </div>
          <div id="kb-planned" class="space-y-2"></div>
        </div>
        <div class="kanban-col p-3">
          <div class="flex items-center gap-2 mb-3">
            <span class="size-2 rounded-full bg-warn animate-pulse"></span>
            <span class="text-xs font-bold uppercase text-warn">Running</span>
            <span id="kb-count-running" class="ml-auto text-xs font-mono text-slate-600">0</span>
          </div>
          <div id="kb-running" class="space-y-2"></div>
        </div>
        <div class="kanban-col p-3">
          <div class="flex items-center gap-2 mb-3">
            <span class="size-2 rounded-full bg-accent-green"></span>
            <span class="text-xs font-bold uppercase text-accent-green">Done</span>
            <span id="kb-count-done" class="ml-auto text-xs font-mono text-slate-600">0</span>
          </div>
          <div id="kb-done" class="space-y-2"></div>
        </div>
      </div>

      <div id="kanban-empty" class="hidden text-center py-16 text-slate-700">
        <span class="ms text-5xl block mb-3">task_alt</span>
        <p class="text-sm font-bold">No tasks yet</p>
        <p class="text-xs mt-1">Use the inbox bot or click NEW TASK</p>
      </div>
    </section>

    <!-- ════════════════ LOGS ════════════════ -->
    <section id="sect-logs" class="sect p-6">
      <div class="flex items-end justify-between mb-4">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">Live <span class="text-primary italic">Logs</span></h1>
          <p id="ws-status-text" class="text-slate-600 font-mono text-xs">WebSocket: disconnected</p>
        </div>
        <div class="flex gap-2 items-center">
          <span id="ws-dot" class="size-2 rounded-full bg-slate-600"></span>
          <select id="log-filter" onchange="filterLogs()" class="px-3 py-1.5 rounded-lg text-xs border border-border-d bg-bg-card text-slate-300">
            <option value="">All sources</option>
          </select>
          <button onclick="clearLogs()" class="px-3 py-1.5 bg-white/5 rounded-lg text-xs font-bold border border-border-d hover:bg-white/10">Clear</button>
        </div>
      </div>

      <div class="card p-0 overflow-hidden" style="height: calc(100vh - 200px);">
        <div class="flex items-center gap-3 px-4 py-2 border-b border-border-d bg-bg-card/50 text-[10px] font-bold text-slate-600 uppercase">
          <span class="w-20">Time</span>
          <span class="w-24">Source</span>
          <span class="w-32">Type</span>
          <span class="flex-1">Detail</span>
          <span class="w-12 text-right">Conf</span>
        </div>
        <div id="log-feed" class="overflow-y-auto font-mono text-xs" style="height: calc(100% - 37px);">
          <div class="text-slate-700 text-center py-8">Connecting to WebSocket...</div>
        </div>
      </div>
    </section>

    <!-- ════════════════ CHAT ════════════════ -->
    <section id="sect-chat" class="sect p-6">
      <div class="flex items-end justify-between mb-4">
        <div>
          <h1 class="text-3xl font-black tracking-tighter uppercase mb-1">Agent <span class="text-primary italic">Chat</span></h1>
          <p class="text-slate-600 font-mono text-xs">PATH: POST /api/agent/chat</p>
        </div>
        <button onclick="clearChat()" class="px-4 py-2 bg-white/5 border border-border-d rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-white/10">
          <span class="ms text-sm">delete</span> CLEAR
        </button>
      </div>

      <div class="card flex flex-col" style="height: calc(100vh - 200px);">
        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
          <div class="text-center text-slate-700 text-sm py-8">
            <span class="ms text-3xl block mb-2">smart_toy</span>
            Send a message to start a conversation with the agent.
          </div>
        </div>
        <!-- Input -->
        <div class="border-t border-border-d p-3 flex gap-2 items-end">
          <textarea id="chat-input" rows="2" placeholder="Message the agent..." 
            class="flex-1 px-3 py-2 rounded-lg text-sm resize-none"
            onkeydown="chatKeydown(event)"></textarea>
          <button id="chat-send-btn" onclick="sendChat()" 
            class="px-5 py-2 bg-primary rounded-lg text-sm font-bold hover:bg-primary/80 transition-colors glow-blue flex items-center gap-2 self-end">
            <span class="ms text-sm">send</span>
          </button>
        </div>
        <div class="px-3 pb-2 flex items-center gap-2" id="chat-status" style="min-height:22px;">
          <span id="chat-status-text" class="text-xs text-slate-600"></span>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Config & Auth
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const DEFAULT_KEY = 'ce2f097de182f6efa822ce9b151eb268c40873acc7efe6c5';
let _apiKey = localStorage.getItem('picoclaw_api_key') || DEFAULT_KEY;

function getApiKey() { return _apiKey; }
function headers() {
  return { 'Content-Type': 'application/json', 'X-API-Key': getApiKey() };
}
function showAuthOverlay() {
  document.getElementById('auth-key-input').value = _apiKey;
  document.getElementById('auth-error').classList.add('hidden');
  document.getElementById('auth-overlay').classList.remove('hidden');
}
function hideAuthOverlay() {
  document.getElementById('auth-overlay').classList.add('hidden');
}
async function saveApiKey() {
  const key = document.getElementById('auth-key-input').value.trim();
  if (!key) return;
  // Test the key
  try {
    const r = await fetch('/api/health', { headers: { 'X-API-Key': key } });
    if (r.status === 401) { document.getElementById('auth-error').classList.remove('hidden'); return; }
    _apiKey = key;
    localStorage.setItem('picoclaw_api_key', key);
    hideAuthOverlay();
    loadCurrentSection();
  } catch { hideAuthOverlay(); }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Navigation
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const SECTIONS = ['overview','channels','agents','kanban','logs','chat'];
let _currentSection = 'overview';

function showSection(name) {
  SECTIONS.forEach(s => {
    document.getElementById(`sect-${s}`).classList.toggle('active', s === name);
  });
  document.querySelectorAll('.nav-item').forEach((el, i) => {
    el.classList.toggle('active', SECTIONS[i] === name);
  });
  _currentSection = name;
  loadCurrentSection();
}

function loadCurrentSection() {
  const loaders = {
    overview: loadOverview,
    channels: loadChannels,
    agents: loadAgents,
    kanban: loadKanban,
    logs: () => {},   // WebSocket, already connected
    chat: () => {},   // stateful, don't reload
  };
  loaders[_currentSection]?.();
}

function refreshCurrentSection() { loadCurrentSection(); }

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Helpers
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function setText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val ?? '—'; }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtBytes(b) {
  if (!b) return '—'; b = Number(b);
  if (b > 1073741824) return (b/1073741824).toFixed(1)+'GB';
  if (b > 1048576) return (b/1048576).toFixed(0)+'MB';
  return (b/1024).toFixed(0)+'KB';
}
function fmtUptime(seconds) {
  if (!seconds) return '—'; seconds = Math.floor(Number(seconds));
  const d = Math.floor(seconds/86400), h = Math.floor((seconds%86400)/3600), m = Math.floor((seconds%3600)/60);
  if (d > 0) return `${d}d ${h}h`;
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}
async function apiFetch(path, opts={}) {
  const r = await fetch(path, { headers: headers(), ...opts });
  if (r.status === 401) { showAuthOverlay(); throw new Error('401'); }
  return r;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// OVERVIEW
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
async function loadOverview() {
  try {
    const [statusR, infoR, sessionsR, cronR] = await Promise.all([
      apiFetch('/api/system/status'),
      apiFetch('/api/system/info'),
      apiFetch('/api/sessions'),
      apiFetch('/api/cron/jobs'),
    ]);
    const [status, info, sessions, cron] = await Promise.all([
      statusR.json(), infoR.json(), sessionsR.json(), cronR.json(),
    ]);

    // Header badges
    const healthOk = !!status.agent?.running;
    const healthEl = document.getElementById('hdr-health');
    healthEl.textContent = healthOk ? '● operational' : '● degraded';
    healthEl.className = `tag ${healthOk ? 'badge-enabled' : 'badge-disabled'}`;
    setText('hdr-model', status.agent?.model || '—');
    document.getElementById('hdr-model').style.cssText = 'background:rgba(23,84,207,.12);color:#7ca2f7;border:1px solid rgba(23,84,207,.3);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;';

    // Sidebar
    setText('sb-uptime', fmtUptime(info.uptime_seconds));
    setText('sb-mem', fmtBytes(info.mem_alloc_bytes));
    setText('sb-goroutines', info.goroutines ?? '—');
    setText('sb-version', info.version || 'dev');

    // Stats
    setText('ov-mem', fmtBytes(info.mem_alloc_bytes));
    setText('ov-uptime', fmtUptime(info.uptime_seconds));
    setText('ov-goroutines', info.goroutines ?? '—');
    const sessionCount = Array.isArray(sessions) ? sessions.length : (sessions?.sessions?.length ?? 0);
    const sessionList = Array.isArray(sessions) ? sessions : (sessions?.sessions ?? []);
    setText('ov-sessions', sessionCount);
    setText('ov-tools', status.agent?.tools ?? '—');
    setText('ov-cron', Array.isArray(cron) ? cron.length : (cron?.jobs?.length ?? 0));

    // Agent status panel
    const tools = status.agent?.tool_names ?? [];
    document.getElementById('ov-agent-body').innerHTML = `
      <div class="flex justify-between"><span class="text-slate-600">Model</span><span class="font-mono text-accent-cyan text-xs">${escHtml(status.agent?.model||'—')}</span></div>
      <div class="flex justify-between"><span class="text-slate-600">Running</span><span class="${status.agent?.running ? 'text-accent-green' : 'text-error'} font-bold text-xs">${status.agent?.running ? 'YES' : 'NO'}</span></div>
      <div class="flex justify-between"><span class="text-slate-600">Tools</span><span class="font-mono text-slate-300 text-xs">${status.agent?.tools ?? 0}</span></div>
      <div class="mt-3 pt-3 border-t border-border-d">
        <p class="text-[10px] text-slate-600 uppercase font-bold mb-2">Registered Tools</p>
        <div class="flex flex-wrap gap-1">
          ${tools.map(t=>`<span class="px-2 py-0.5 bg-primary/10 text-primary rounded text-[10px] font-mono border border-primary/20">${escHtml(t)}</span>`).join('')}
        </div>
      </div>`;

    // Channels panel
    const chans = status.channels ?? {};
    const chanHtml = Object.entries(chans).map(([name, info]) => {
      const on = info?.enabled ?? info?.connected ?? false;
      return `<div class="flex items-center justify-between">
        <span class="text-slate-400 capitalize">${name}</span>
        <span class="tag ${on ? 'badge-enabled' : 'badge-disabled'}">${on ? '● on' : '○ off'}</span>
      </div>`;
    }).join('') || '<p class="text-slate-600 text-xs">No channel data</p>';
    document.getElementById('ov-channels-body').innerHTML = chanHtml;

    // Sessions list
    setText('ov-session-count', `${sessionCount} session${sessionCount !== 1 ? 's' : ''}`);
    if (sessionList.length === 0) {
      document.getElementById('ov-sessions-list').innerHTML = '<p class="text-slate-600 text-xs">No active sessions</p>';
    } else {
      document.getElementById('ov-sessions-list').innerHTML = sessionList.slice(0, 10).map(s => `
        <div class="flex items-center justify-between p-2 rounded-lg bg-white/3 border border-border-d hover:border-primary/30 transition-all">
          <span class="font-mono text-xs text-slate-400">${escHtml(s.key || s.id || '—')}</span>
          <span class="text-[10px] text-slate-600">${s.message_count ?? 0} msgs</span>
        </div>`).join('');
    }
  } catch(e) { if (e.message !== '401') console.error('overview', e); }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CHANNELS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const CHANNEL_META = {
  telegram:  { icon: 'send',        color: 'text-accent-cyan',  desc: 'Telegram bot — @gvinboxbot (currently disabled in gateway, @gvneobot handled by inbox_bot.py)' },
  discord:   { icon: 'tag',         color: 'text-primary',      desc: 'Discord bot. Requires Bot Token from Discord Developer Portal.' },
  slack:     { icon: 'view_sidebar',color: 'text-accent-green', desc: 'Slack bot. Requires Bot Token + App Token (socket mode).' },
  whatsapp:  { icon: 'chat',        color: 'text-accent-green', desc: 'WhatsApp via bridge (mautrix-whatsapp). Requires ws://localhost:3001.' },
  feishu:    { icon: 'group',       color: 'text-accent-cyan',  desc: 'Feishu / Lark. Requires App ID + App Secret from Feishu Open Platform.' },
  dingtalk:  { icon: 'domain',      color: 'text-warn',         desc: 'DingTalk. Requires Client ID + Client Secret.' },
  qq:        { icon: 'person',      color: 'text-primary',      desc: 'QQ via open platform. Requires App ID + Token.' },
  maixcam:   { icon: 'videocam',    color: 'text-accent-green', desc: 'MaixCam device channel over local network.' },
};

async function loadChannels() {
  try {
    const r = await apiFetch('/api/channels');
    const data = await r.json();
    const channels = data.channels ?? data ?? {};
    const grid = document.getElementById('channels-grid');
    if (!Object.keys(channels).length) {
      grid.innerHTML = '<p class="text-slate-600 text-sm">No channel data returned</p>';
      return;
    }
    grid.innerHTML = Object.entries(channels).map(([name, info]) => {
      const meta = CHANNEL_META[name] ?? { icon: 'hub', color: 'text-slate-400', desc: '' };
      const enabled = info?.enabled ?? false;
      const configKeys = Object.entries(info ?? {}).filter(([k]) => k !== 'enabled' && k !== 'allow_from');
      const hasCredentials = configKeys.some(([, v]) => v && v !== '' && v !== 0);
      return `
        <div class="card p-5 flex flex-col gap-3 transition-all ${enabled ? 'border-accent-green/30' : ''}">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-2.5">
              <span class="ms ${meta.color} text-2xl">${meta.icon}</span>
              <div>
                <h4 class="font-bold capitalize">${name}</h4>
                <p class="text-[10px] text-slate-600 font-mono">${name.toUpperCase()}_CHANNEL</p>
              </div>
            </div>
            <span class="tag ${enabled ? 'badge-enabled' : 'badge-disabled'}">${enabled ? '● enabled' : '○ disabled'}</span>
          </div>
          <p class="text-xs text-slate-500">${meta.desc}</p>
          ${configKeys.length ? `<div class="space-y-1 pt-2 border-t border-border-d">
            ${configKeys.map(([k, v]) => `
              <div class="flex justify-between text-xs">
                <span class="text-slate-600 font-mono">${k}</span>
                <span class="font-mono ${v ? 'text-slate-400' : 'text-slate-700'}">${v ? (String(v).length > 20 ? '***' : escHtml(String(v))) : 'not set'}
                </span>
              </div>`).join('')}
          </div>` : ''}
          ${!enabled ? `<p class="text-[10px] text-slate-700 mt-1">
            ${hasCredentials ? 'Credentials present — set "enabled": true and restart.' : 'Add credentials to config.json to enable.'}
          </p>` : ''}
        </div>`;
    }).join('');
  } catch(e) { if (e.message !== '401') console.error('channels', e); }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// AGENTS & TOOLS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
async function loadAgents() {
  try {
    const [agentR, toolsR, cronR] = await Promise.all([
      apiFetch('/api/agent/status'),
      apiFetch('/api/tools'),
      apiFetch('/api/cron/jobs'),
    ]);
    const [agent, toolsData, cronData] = await Promise.all([agentR.json(), toolsR.json(), cronR.json()]);

    // Agent config
    document.getElementById('agent-config-body').innerHTML = `
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-slate-600">Model</span><span class="font-mono text-accent-cyan text-xs">${escHtml(agent.model||'—')}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">Status</span><span class="${agent.running?'text-accent-green':'text-error'} font-bold text-xs">${agent.running?'Running':'Stopped'}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">Max Tokens</span><span class="font-mono text-slate-300 text-xs">${agent.max_tokens??'—'}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">Temperature</span><span class="font-mono text-slate-300 text-xs">${agent.temperature??'—'}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">Max Iterations</span><span class="font-mono text-slate-300 text-xs">${agent.max_tool_iterations??'—'}</span></div>
        <div class="flex justify-between"><span class="text-slate-600">Workspace</span><span class="font-mono text-slate-500 text-[10px] truncate max-w-24">${escHtml(agent.workspace||'—')}</span></div>
        ${agent.skills?.length ? `
        <div class="pt-3 border-t border-border-d">
          <p class="text-[10px] text-slate-600 uppercase font-bold mb-2">Skills</p>
          ${agent.skills.map(s=>`<div class="text-xs text-accent-cyan font-mono truncate">${escHtml(s)}</div>`).join('')}
        </div>` : ''}
      </div>`;

    // Tools list
    const tools = toolsData.tools ?? [];
    setText('tools-count', tools.length);
    document.getElementById('tools-list').innerHTML = tools.map(t => `
      <div class="p-3 rounded-lg bg-white/3 border border-border-d hover:border-primary/30 transition-all">
        <div class="flex items-center justify-between mb-1">
          <span class="font-mono text-sm text-accent-cyan font-bold">${escHtml(t.name)}</span>
          ${t.ops ? `<span class="text-[10px] text-slate-600 font-mono">${t.ops.length} ops</span>` : ''}
        </div>
        <p class="text-xs text-slate-500">${escHtml(t.description||'')}</p>
        ${t.ops ? `<div class="flex flex-wrap gap-1 mt-2">${t.ops.map(op=>`<span class="px-2 py-0.5 bg-bg-dark text-slate-500 rounded text-[10px] font-mono border border-border-d">${escHtml(op)}</span>`).join('')}</div>` : ''}
      </div>`).join('') || '<p class="text-slate-600 text-xs">No tools registered</p>';

    // Cron jobs
    const jobs = cronData.jobs ?? (Array.isArray(cronData) ? cronData : []);
    document.getElementById('cron-list').innerHTML = jobs.length ? jobs.map(j => `
      <div class="flex items-center justify-between p-2 rounded-lg bg-white/3 border border-border-d">
        <div class="flex-1 min-w-0">
          <span class="font-mono text-xs text-slate-300">${escHtml(j.name||j.id||'unnamed')}</span>
          <span class="ml-3 text-[10px] text-slate-600">${escHtml(j.schedule||j.interval||'')}</span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          ${j.last_run ? `<span class="text-[10px] text-slate-600 font-mono">${new Date(j.last_run).toLocaleTimeString()}</span>` : ''}
          <span class="tag ${j.enabled!==false ? 'badge-enabled' : 'badge-disabled'}">${j.enabled!==false ? 'on' : 'off'}</span>
        </div>
      </div>`).join('') : '<p class="text-slate-600 text-xs">No cron jobs configured</p>';
  } catch(e) { if (e.message !== '401') console.error('agents', e); }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// KANBAN
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const KB_COLS = { inbox: 'kb-inbox', planned: 'kb-planned', running: 'kb-running', done: 'kb-done' };
const KB_PRIORITY_COLOR = { high: 'text-error', medium: 'text-warn', low: 'text-slate-500', normal: 'text-slate-500' };

async function loadKanban() {
  try {
    const r = await apiFetch('/api/tasks');
    const data = await r.json();
    const tasks = data.tasks ?? (Array.isArray(data) ? data : []);

    Object.values(KB_COLS).forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });
    const counts = { inbox: 0, planned: 0, running: 0, done: 0 };

    if (tasks.length === 0) {
      document.getElementById('kanban-empty').classList.remove('hidden');
    } else {
      document.getElementById('kanban-empty').classList.add('hidden');
      tasks.forEach(task => {
        const state = (task.state || task.status || 'inbox').toLowerCase();
        const colState = KB_COLS[state] ? state : 'inbox';
        counts[colState]++;
        const el = document.createElement('div');
        el.className = 'kanban-card p-3';
        const prio = (task.priority || 'normal').toLowerCase();
        const prioColor = KB_PRIORITY_COLOR[prio] || 'text-slate-500';
        el.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-2">
            <span class="text-xs font-bold text-slate-300 leading-snug flex-1">${escHtml(task.title||task.name||'Untitled')}</span>
            <span class="text-[10px] font-mono ${prioColor} shrink-0">${task.id||''}</span>
          </div>
          ${task.project ? `<p class="text-[10px] text-slate-600 font-mono mb-1">${escHtml(task.project)}</p>` : ''}
          ${task.body||task.description ? `<p class="text-[10px] text-slate-500 line-clamp-2">${escHtml((task.body||task.description).slice(0,100))}</p>` : ''}
          <div class="flex items-center justify-between mt-2">
            <span class="text-[10px] text-slate-700">${task.created_at ? new Date(task.created_at).toLocaleDateString() : ''}</span>
            <span class="text-[10px] ${prioColor} uppercase font-bold">${prio !== 'normal' ? prio : ''}</span>
          </div>`;
        document.getElementById(KB_COLS[colState]).appendChild(el);
      });
    }
    Object.entries(counts).forEach(([k, v]) => setText(`kb-count-${k}`, v));
  } catch(e) { if (e.message !== '401') console.error('kanban', e); }
}

function showAddTask() { document.getElementById('add-task-form').classList.remove('hidden'); }
function hideAddTask() { document.getElementById('add-task-form').classList.add('hidden'); }
async function createTask() {
  const title = document.getElementById('task-title').value.trim();
  if (!title) return;
  const project = document.getElementById('task-project').value.trim();
  try {
    await apiFetch('/api/tasks', {
      method: 'POST',
      body: JSON.stringify({ title, project: project || undefined, state: 'inbox' }),
    });
    document.getElementById('task-title').value = '';
    hideAddTask();
    await loadKanban();
  } catch(e) { if (e.message !== '401') alert('Failed to create task: ' + e.message); }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// LOGS (WebSocket)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const logState = { events: [], maxEvents: 500, sources: new Set(), filter: '' };
let ws, wsReconnectTimer;

function connectWebSocket() {
  clearTimeout(wsReconnectTimer);
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url = `${proto}//${location.host}/api/ws`;
  try { ws = new WebSocket(url); } catch { wsReconnect(); return; }
  ws.onopen = () => {
    document.getElementById('ws-dot').className = 'size-2 rounded-full bg-accent-green animate-pulse';
    setText('ws-status-text', `WebSocket: connected — ${url}`);
  };
  ws.onmessage = e => {
    try { pushLog(JSON.parse(e.data)); } catch {}
  };
  ws.onclose = ws.onerror = () => {
    document.getElementById('ws-dot').className = 'size-2 rounded-full bg-error';
    setText('ws-status-text', 'WebSocket: reconnecting...');
    wsReconnect();
  };
}

function wsReconnect() { wsReconnectTimer = setTimeout(connectWebSocket, 5000); }

function pushLog(evt) {
  const src = evt.source || evt.type?.split('.')[0] || 'system';
  logState.sources.add(src);
  logState.events.push({ ...evt, source: src });
  if (logState.events.length > logState.maxEvents) logState.events.shift();
  // Rebuild source filter
  const sel = document.getElementById('log-filter');
  if (sel && !sel.querySelector(`option[value="${src}"]`)) {
    const o = document.createElement('option'); o.value = o.textContent = src;
    sel.appendChild(o);
  }
  if (logState.filter && src !== logState.filter) return;
  appendLogRow(evt, src);
}

function appendLogRow(evt, src) {
  const feed = document.getElementById('log-feed');
  if (!feed) return;
  if (feed.querySelector('.text-slate-700')) feed.innerHTML = '';
  const conf = evt.confidence;
  const confColor = conf >= 0.7 ? 'text-accent-green' : conf >= 0.4 ? 'text-warn' : 'text-slate-600';
  const typeColor = (evt.type||'').includes('error') || (evt.type||'').includes('fail') ? 'text-error' : 'text-accent-cyan';
  const time = evt.timestamp ? new Date(evt.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
  const detail = evt.message || evt.data?.message || evt.data?.title || (evt.data ? JSON.stringify(evt.data).slice(0,120) : '');
  const div = document.createElement('div');
  div.className = 'flex items-start gap-3 px-4 py-2 hover:bg-white/3 border-b border-border-d/50 transition-all';
  div.innerHTML = `
    <span class="w-20 text-slate-600 shrink-0">${escHtml(time)}</span>
    <span class="w-24 text-slate-500 shrink-0 truncate font-mono">${escHtml(src)}</span>
    <span class="w-32 ${typeColor} shrink-0 truncate">${escHtml(evt.type||'event')}</span>
    <span class="flex-1 text-slate-400 truncate">${escHtml(String(detail))}</span>
    <span class="w-12 text-right ${confColor} shrink-0">${conf !== undefined ? Math.round(conf*100)+'%' : ''}</span>`;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
}

function filterLogs() {
  logState.filter = document.getElementById('log-filter')?.value || '';
  const feed = document.getElementById('log-feed'); if (!feed) return;
  feed.innerHTML = '';
  const filtered = logState.filter ? logState.events.filter(e => e.source === logState.filter) : logState.events;
  if (!filtered.length) { feed.innerHTML = '<div class="text-slate-700 text-center py-8">No events match filter</div>'; return; }
  filtered.forEach(e => appendLogRow(e, e.source));
  feed.scrollTop = feed.scrollHeight;
}

function clearLogs() {
  logState.events = []; logState.sources = new Set();
  const feed = document.getElementById('log-feed'); if (feed) feed.innerHTML = '<div class="text-slate-700 text-center py-8">Cleared — waiting for events...</div>';
  const sel = document.getElementById('log-filter'); if (sel) sel.innerHTML = '<option value="">All sources</option>';
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CHAT
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
let chatSending = false;
const chatHistory = [];

function chatKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}

async function sendChat() {
  if (chatSending) return;
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';
  chatSending = true;
  const btn = document.getElementById('chat-send-btn');
  btn.innerHTML = '<span class="spinner"></span>';

  addChatMessage(message, 'user');
  chatHistory.push({ role: 'user', content: message });

  const statusEl = document.getElementById('chat-status-text');
  statusEl.textContent = 'Agent thinking...';

  try {
    const r = await apiFetch('/api/agent/chat', {
      method: 'POST',
      body: JSON.stringify({ message, history: chatHistory.slice(-10) }),
    });
    const data = await r.json();
    const reply = data.response || data.message || data.content || JSON.stringify(data);
    addChatMessage(reply, 'agent');
    chatHistory.push({ role: 'assistant', content: reply });
    statusEl.textContent = '';
  } catch(e) {
    if (e.message !== '401') {
      addChatMessage(`Error: ${e.message}`, 'error');
      statusEl.textContent = 'Request failed';
    }
  } finally {
    chatSending = false;
    btn.innerHTML = '<span class="ms text-sm">send</span>';
  }
}

function addChatMessage(text, role) {
  const msgs = document.getElementById('chat-messages');
  if (msgs.querySelector('.text-slate-700')) msgs.innerHTML = '';
  const div = document.createElement('div');
  div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
  const cls = role === 'user' ? 'chat-bubble-user' : role === 'error' ? 'border border-error/30 bg-error/10 rounded-xl' : 'chat-bubble-agent';
  div.innerHTML = `<div class="${cls} p-3 max-w-xl">
    <div class="text-[10px] font-bold mb-1 ${role === 'user' ? 'text-primary' : role === 'error' ? 'text-error' : 'text-accent-green'} uppercase">${role === 'user' ? 'You' : role === 'error' ? 'Error' : 'Agent'}</div>
    <div class="text-sm text-slate-300 whitespace-pre-wrap">${escHtml(text)}</div>
  </div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function clearChat() {
  chatHistory.length = 0;
  document.getElementById('chat-messages').innerHTML = '<div class="text-center text-slate-700 text-sm py-8"><span class="ms text-3xl block mb-2">smart_toy</span>Send a message to start a conversation with the agent.</div>';
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Init
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
document.addEventListener('DOMContentLoaded', () => {
  connectWebSocket();
  loadOverview();
  // Auto-refresh overview every 30s
  setInterval(() => { if (_currentSection === 'overview') loadOverview(); }, 30000);
});

// Close auth overlay on background click
document.getElementById('auth-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('auth-overlay')) hideAuthOverlay();
});
</script>
</body>
</html>
